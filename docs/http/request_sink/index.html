
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Aqueduct, a Dart server-side framework.">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.1, mkdocs-material-1.1.1">
    
    
      
        <title>Initialization and the RequestSink - Aqueduct</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-4ebe3f1d68.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../style/css/override.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Aqueduct" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  HTTP
                </span>
              
            
            Initialization and the RequestSink
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Aqueduct
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/getting-started/" title="1. Getting Started" class="md-nav__link">
      1. Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/writing-tests/" title="2. Writing Tests" class="md-nav__link">
      2. Writing Tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/executing-queries/" title="3. Executing Database Queries" class="md-nav__link">
      3. Executing Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/model-relationships-and-joins/" title="4. Advanced Database Queries" class="md-nav__link">
      4. Advanced Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/deploying-and-other-fun-things/" title="5. Deploying" class="md-nav__link">
      5. Deploying
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      HTTP
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        HTTP
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../structure/" title="Application Structure" class="md-nav__link">
      Application Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../request_and_response/" title="Request and Response Objects" class="md-nav__link">
      Request and Response Objects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../request_controller/" title="Handling Requests: Fundamentals" class="md-nav__link">
      Handling Requests: Fundamentals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../routing/" title="Routing" class="md-nav__link">
      Routing
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Initialization and the RequestSink
      </label>
    
    <a href="./" title="Initialization and the RequestSink" class="md-nav__link md-nav__link--active">
      Initialization and the RequestSink
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#subclassing-requestsink" title="Subclassing RequestSink" class="md-nav__link">
    Subclassing RequestSink
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-requestsinkinitializeapplication-for-one-time-initialization" title="Use RequestSink.initializeApplication for One-Time Initialization" class="md-nav__link">
    Use RequestSink.initializeApplication for One-Time Initialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-requestsinks-constructor-to-initialize-resources-and-isolate-specific-configurations" title="Use RequestSink's Constructor to Initialize Resources and Isolate-Specific Configurations" class="md-nav__link">
    Use RequestSink's Constructor to Initialize Resources and Isolate-Specific Configurations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-routes-in-setuprouter" title="Setting up Routes in setupRouter" class="md-nav__link">
    Setting up Routes in setupRouter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perform-asynchronous-initialization-with-willopen" title="Perform Asynchronous Initialization with willOpen" class="md-nav__link">
    Perform Asynchronous Initialization with willOpen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-receiving-requests" title="Start Receiving Requests" class="md-nav__link">
    Start Receiving Requests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazy-resources" title="Lazy Resources" class="md-nav__link">
    Lazy Resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-threaded-aqueduct-applications" title="Multi-threaded Aqueduct Applications" class="md-nav__link">
    Multi-threaded Aqueduct Applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preprocessing-requests-and-initialhandler" title="Preprocessing Requests and initialHandler" class="md-nav__link">
    Preprocessing Requests and initialHandler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-application-object" title="The Application Object" class="md-nav__link">
    The Application Object
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../http_controller/" title="Handling Requests: HTTPController" class="md-nav__link">
      Handling Requests: HTTPController
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cors/" title="CORS Configuration" class="md-nav__link">
      CORS Configuration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Database/ORM
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Database/ORM
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/modeling_data/" title="Modeling Data" class="md-nav__link">
      Modeling Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/serialization/" title="Storage, Serialization and Deserialization" class="md-nav__link">
      Storage, Serialization and Deserialization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/executing_queries/" title="Executing Queries" class="md-nav__link">
      Executing Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/advanced_queries/" title="Advanced Queries" class="md-nav__link">
      Advanced Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/db_tools/" title="Migration and Tooling" class="md-nav__link">
      Migration and Tooling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/inside_the_db/" title="Inside the DB" class="md-nav__link">
      Inside the DB
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      OAuth 2.0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        OAuth 2.0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/server/" title="Setting up Authorization" class="md-nav__link">
      Setting up Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/authorizer/" title="Protected Routes" class="md-nav__link">
      Protected Routes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/controllers/" title="Issuing Access Tokens" class="md-nav__link">
      Issuing Access Tokens
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/cli/" title="Creating OAuth 2.0 Clients" class="md-nav__link">
      Creating OAuth 2.0 Clients
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/what_is_oauth/" title="What is OAuth 2.0?" class="md-nav__link">
      What is OAuth 2.0?
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Testing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Testing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/harness/" title="Test Harness" class="md-nav__link">
      Test Harness
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/test_client/" title="Writing Tests and the TestClient" class="md-nav__link">
      Writing Tests and the TestClient
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_local/" title="Deploy Locally" class="md-nav__link">
      Deploy Locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_heroku/" title="Deploy on Heroku" class="md-nav__link">
      Deploy on Heroku
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_aws/" title="Deploy on AWS" class="md-nav__link">
      Deploy on AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/script/" title="Deploying without aqueduct serve" class="md-nav__link">
      Deploying without aqueduct serve
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#subclassing-requestsink" title="Subclassing RequestSink" class="md-nav__link">
    Subclassing RequestSink
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-requestsinkinitializeapplication-for-one-time-initialization" title="Use RequestSink.initializeApplication for One-Time Initialization" class="md-nav__link">
    Use RequestSink.initializeApplication for One-Time Initialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-requestsinks-constructor-to-initialize-resources-and-isolate-specific-configurations" title="Use RequestSink's Constructor to Initialize Resources and Isolate-Specific Configurations" class="md-nav__link">
    Use RequestSink's Constructor to Initialize Resources and Isolate-Specific Configurations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-routes-in-setuprouter" title="Setting up Routes in setupRouter" class="md-nav__link">
    Setting up Routes in setupRouter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perform-asynchronous-initialization-with-willopen" title="Perform Asynchronous Initialization with willOpen" class="md-nav__link">
    Perform Asynchronous Initialization with willOpen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-receiving-requests" title="Start Receiving Requests" class="md-nav__link">
    Start Receiving Requests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazy-resources" title="Lazy Resources" class="md-nav__link">
    Lazy Resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-threaded-aqueduct-applications" title="Multi-threaded Aqueduct Applications" class="md-nav__link">
    Multi-threaded Aqueduct Applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preprocessing-requests-and-initialhandler" title="Preprocessing Requests and initialHandler" class="md-nav__link">
    Preprocessing Requests and initialHandler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-application-object" title="The Application Object" class="md-nav__link">
    The Application Object
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/stablekernel/aqueduct/edit/master/docs/http/request_sink.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                <h1 id="application-initialization-and-the-requestsink">Application Initialization and the RequestSink</h1>
<p>The only requirement of an Aqueduct application is that it has exactly one <code>RequestSink</code> subclass. This subclass handles the initialization of an application, including setting up routes, authorization and database connections.</p>
<p>By convention, a <code>RequestSink</code> subclass is declared in its own file named <code>lib/&lt;application_name&gt;_request_sink.dart</code>. This file must visible to the application library file. (In an application named <code>foo</code>, the library file is <code>lib/foo.dart</code>.) An example directory structure:</p>
<div class="codehilite"><pre><span></span>wildfire/
  lib/
    wildfire.dart
    wildfire_request_sink.dart
    controllers/
      user_controller.dart      
    ...
</pre></div>


<p>To make the <code>RequestSink</code> subclass visible, the file <code>wildfire.dart</code> imports <code>wildfire_request_sink.dart</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">import</span> <span class="s1">&#39;wildfire_request_sink.dart&#39;</span><span class="p">;</span>
</pre></div>


<p>Applications are run with the command line tool <code>aqueduct serve</code>. This tool finds the subclass of <code>RequestSink</code> visible to the application library file.</p>
<p>An Aqueduct application will create multiple instances of a <code>RequestSink</code> subclass. Each instance has its own <code>Isolate</code> - Dart's version of a thread - that it will process requests on. This behavior allows an application's code to be replicated across a number of threads.</p>
<h2 id="subclassing-requestsink">Subclassing RequestSink</h2>
<p>The responsibility of a <code>RequestSink</code> is to set up routes and initialize resources it will use to fulfill requests. There are five initialization methods in <code>RequestSink</code>, each with its own purpose. The methods and the order they are executed in are as follows:</p>
<ol>
<li><code>RequestSink.initializeApplication</code>: this <em>static</em> method is called once at the very beginning of an application's startup, before any instances of <code>RequestSink</code> are created.</li>
<li>An instance of <code>RequestSink</code> is created with its default constructor.</li>
<li>The method <code>setupRouter</code> is invoked on the <code>RequestSink</code> instance; initialized properties from the constructor are injected into controllers created here.</li>
<li>The method <code>willOpen</code> is invoked on the <code>RequestSink</code> instance.</li>
<li>The method <code>didOpen</code> is invoked on the <code>RequestSink</code> instance.</li>
</ol>
<p>Only <code>setupRouter</code> is required, but it is extremely common to provide a constructor and implement <code>RequestSink.initializeApplication</code>. It is rare to use <code>willOpen</code> and rarer still to use <code>didOpen</code>.</p>
<p>Aqueduct applications will create more than one instance of <code>RequestSink</code> and repeat steps 2-5 for each instance. See a later section on multi-threading in Aqueduct applications.</p>
<p>The usage and details for each of these initialization methods is detailed in the following sections.</p>
<h3 id="use-requestsinkinitializeapplication-for-one-time-initialization">Use RequestSink.initializeApplication for One-Time Initialization</h3>
<p>Since many instances of <code>RequestSink</code> will be created in an Aqueduct application, its instance methods and constructor will be called multiple times. An Aqueduct application may often have to execute one-time startup tasks that must not occur more than once. For this purpose, you may implement a <em>static</em> method with the following name and signature in an application's <code>RequestSink</code>:</p>
<div class="codehilite"><pre><span></span><span class="kd">static</span> <span class="n">Future</span> <span class="n">initializeApplication</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="p">...</span> <span class="k">do</span> <span class="n">one</span> <span class="n">time</span> <span class="n">setup</span> <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<p>A common use of this method is to set up resources that will be shared across isolates or unique persistent connections to remote services. This method can modify <code>ApplicationConfiguration</code> prior to <code>RequestSink</code> instances being created. This allows resources allocated during this one-time setup method can be accessible by each <code>RequestSink</code> instance.</p>
<p>In its simplest form, <code>initializeApplication</code> will often read values from a configuration file and set them in the <code>ApplicationConfiguration.options</code> map. That looks like this:</p>
<div class="codehilite"><pre><span></span><span class="kd">static</span> <span class="n">Future</span> <span class="n">initializeApplication</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>        
  <span class="n">config</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;Configuration Values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">configurationFilePath</span><span class="p">);;</span>
<span class="p">}</span>  

<span class="n">RequestSink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">parsedConfigValues</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;Configuration Values&quot;</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>


<p>In a more complex example, Aqueduct applications that use <a href="https://pub.dartlang.org/packages/scribe">scribe</a> will implement <code>initializeApplication</code> to optimize logging. <code>scribe</code> works by spawning a new isolate that writes log statements to disk or the console. Other isolates that do work send their log messages to <code>scribe</code>'s logging isolate so that they can move on to more important things. The logging isolate is spawned in <code>initializeApplication</code>, and a communication port to that isolate is added to the <code>ApplicationConfiguration</code>. Each <code>RequestSink</code> grabs that communication port so that it can send messages to the logging isolate later.</p>
<p>It is important to note the behavior of isolates as it relates to Aqueduct and the initialization process. Each isolate has its own heap. <code>initializeApplication</code> is executed in the main isolate, whereas each <code>RequestSink</code> is instantiated in its own isolate. This means that any values stored in <code>ApplicationConfiguration</code> must be safe to pass across isolates - i.e., they can't contain references to closures.</p>
<p>Additionally, any static or global variables that are set in the main isolate <em>will not be set</em> in other isolates. Static properties like the encoder and decoder maps created by <code>Response.addEncoder</code> and <code>HTTPBody.addDecoder</code> must not be modified in <code>initializeApplication</code>, since these changes will not occur in other isolates. For initialization that is isolate-specific, see later sections.</p>
<p>Also, because static methods cannot be overridden in Dart, it is important that you ensure the name and signature of <code>initializeApplication</code> exactly matches what is shown in these code samples. The analyzer can't help you here, unfortunately.</p>
<h3 id="use-requestsinks-constructor-to-initialize-resources-and-isolate-specific-configurations">Use RequestSink's Constructor to Initialize Resources and Isolate-Specific Configurations</h3>
<p>A resource, in this context, is something your application will use to fulfill requests. A database connection is an example of a resource. Resources should be created the constructor of a <code>RequestSink</code> and stored as properties.</p>
<p>The constructor of a <code>RequestSink</code> must be unnamed and take a single argument of type <code>ApplicationConfiguration</code>. This instance of <code>ApplicationConfiguration</code> will have the same values as the instance in the previous initialization step (<code>initializeApplication</code>) and will retain any values this step applied to the configuration. The values in <code>ApplicationConfiguration</code> often contain the details for the resources that should be created - like database connection information. Here is an example:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">MySink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">MySink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">databaseConnectionInfo</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Database Connection Info&quot;</span><span class="p">];</span>
    <span class="kd">var</span> <span class="n">databaseConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatabaseConnection</span><span class="p">()</span>
      <span class="p">..</span><span class="n">connectionInfo</span> <span class="o">=</span> <span class="n">databaseConnectionInfo</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Isolate specific initialization should also be set in this method.</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">MySink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">MySink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Response</span><span class="p">.</span><span class="n">addEncoder</span><span class="p">(</span><span class="k">new</span> <span class="n">ContentType</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="s2">&quot;xml&quot;</span><span class="p">),</span> <span class="n">xmlEncoder</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>  
</pre></div>


<p>All of the properties of a <code>RequestSink</code> should be initialized in its constructor. This allows the next phase of initialization - setting up routes - to inject these resources into controllers. For example, a typical <code>RequestSink</code> will have some property that holds a database connection; this property should be initialized in the constructor.</p>
<p>A constructor for a <code>RequestSink</code> may look like this:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">WildfireSink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="kt">String</span> <span class="n">ConfigurationKey</span> <span class="o">=</span> <span class="s2">&quot;config&quot;</span><span class="p">;</span>

  <span class="kd">static</span> <span class="n">Future</span> <span class="n">initializeApplication</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>        
    <span class="n">config</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="n">ConfigurationKey</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">configurationFilePath</span><span class="p">);</span>
  <span class="p">}</span>  

  <span class="n">WildfireSink</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">opts</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">WildfireConfiguration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="n">ConfigurationKey</span><span class="p">];</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">contextWithConnectionInfo</span><span class="p">(</span><span class="n">configuration</span><span class="p">.</span><span class="n">database</span><span class="p">);</span>

    <span class="n">authServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthServer</span><span class="o">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">Token</span><span class="p">,</span> <span class="n">AuthCode</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">WildfireAuthDelegate</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">ManagedContext</span> <span class="n">context</span><span class="p">;</span>
  <span class="n">AuthServer</span> <span class="n">authServer</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>A constructor should never call asynchronous functions. Some resources require asynchronous initialization - e.g., a database connection has to connect to a database - but those must be fully initialized later. (See a later section on Lazy Resources.)</p>
<h3 id="setting-up-routes-in-setuprouter">Setting up Routes in setupRouter</h3>
<p>Once a <code>RequestSink</code> is instantiated, its <code>setupRouter</code> method is invoked. This method takes a <code>Router</code> that you must configure with all of the routes your application will respond to. (See <a href="../routing/">Routing</a> for more details.)</p>
<p>When setting up routes, you will create many instances of <code>RequestController</code>. Any resources these controllers need should be injected in their constructor. For example, <code>Authorizer</code>s need an instance of <code>AuthServer</code> to validate a request. The following code is an example of this:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">MySink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">MySink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>  
    <span class="n">authServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthServer</span><span class="p">(...);</span>
  <span class="p">}</span>

  <span class="n">AuthServer</span> <span class="n">authServer</span><span class="p">;</span>

  <span class="err">@</span><span class="n">override</span>
  <span class="kt">void</span> <span class="n">setupRouter</span><span class="p">(</span><span class="n">Router</span> <span class="n">router</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">router</span>
        <span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/path&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">new</span> <span class="n">Authorizer</span><span class="p">(</span><span class="n">authServer</span><span class="p">))</span>
        <span class="p">.</span><span class="n">listen</span><span class="p">((</span><span class="n">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Authorized!&quot;</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This is the only time routes may be set up in an application, as the <code>Router</code> will restructure its registered routes into an optimized, immutable collection after this method is invoked.</p>
<p>You may not call any asynchronous functions in this this method and you should not alter the state of any properties.</p>
<p>After <code>setupRouter</code> has completed, the <code>RequestSink.router</code> property is set to the router this method configured.</p>
<h3 id="perform-asynchronous-initialization-with-willopen">Perform Asynchronous Initialization with willOpen</h3>
<p>For any initialization that needs to occur asynchronously, you may override <code>RequestSink.willOpen</code>. This method is asynchronous, and the application will wait for this method to complete before sending any HTTP requests to the request sink. In general, you should avoid using this method and read the later section on Lazy Resources.</p>
<h3 id="start-receiving-requests">Start Receiving Requests</h3>
<p>Once an <code>RequestSink</code> sets up its routes and performs asynchronous initialization, the application will hook up the stream of HTTP requests to the <code>RequestSink</code> and data will start flowing. Just prior to this, one last method is invoked on <code>RequestSink</code>, <code>didOpen</code>. This method is a final callback to the <code>RequestSink</code> that indicates all initialization has completed.</p>
<h2 id="lazy-resources">Lazy Resources</h2>
<p>An Aqueduct application will probably communicate to other servers and databases. A <code>RequestSink</code> will have properties to represent these connections. Resources like these must open a persistent network connection, a process that is asynchronous by nature. Following the initialization process of a <code>RequestSink</code>, it may then make sense to create the resources in a constructor and then open them in <code>willOpen</code>. And while this could be true, resources like this should manage the opening and closing of their underlying network connection internally.</p>
<p>For example, an object that has a database connection should open it when it goes to execute a query, but doesn't have a valid connection. This is how <code>PersistentStore</code>s work - they store properties that have all of the information they need to connect to a database when initialized, but do not immediately open a connection. The first time the <code>PersistentStore</code> has to fulfill a query, it executes a function that opens the database connection. This defers fully loading the resource until it is needed, but there is actually a much more important behavior here.</p>
<p>An Aqueduct application (ideally) will run for a long time. During that time, the servers and databases it connects to may not always be reachable - perhaps they went down to be upgraded or there was an outage of some kind. An Aqueduct application must be able to recover from this. If opening an external connection only happened during startup, an application would not reopen a connection if it went down for some reason. This would be bad.</p>
<p>In the general case, a resource of this nature will have methods that use the underlying connection. These methods must be responsible for ensuring the underlying connection is valid and reopen it (or report failure) if that is not the case. For example, a simple database connection class might implement its <code>execute</code> method like so:</p>
<div class="codehilite"><pre><span></span><span class="n">Future</span> <span class="n">execute</span><span class="p">(</span><span class="kt">String</span> <span class="n">sql</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">connection</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">connection</span><span class="p">.</span><span class="n">isAvailable</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Connection</span><span class="p">(...);</span>
    <span class="kd">await</span> <span class="n">connection</span><span class="p">.</span><span class="n">open</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kd">await</span> <span class="n">connection</span><span class="p">.</span><span class="n">executeSQL</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>From the perspective of a <code>RequestController</code>, it doesn't care about the underlying connection. It invokes <code>execute</code>, and the connection object figures out if it needs to establish a connection first:</p>
<div class="codehilite"><pre><span></span><span class="err">@</span><span class="n">httpGet</span> <span class="n">getThings</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="c1">// May or may not create a new connection, but will either return</span>
  <span class="c1">// some things or throw an error.</span>
  <span class="kd">var</span> <span class="n">things</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">connection</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from things&quot;</span><span class="p">);</span>

  <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<h2 id="multi-threaded-aqueduct-applications">Multi-threaded Aqueduct Applications</h2>
<p>Aqueduct applications can - and should - be spread across a number of threads. This allows an application to take advantage of multiple CPUs and serve requests faster. In Dart, threads are called <em>isolates</em> (and have some slight nuances to them that makes the different than a traditional thread). Spreading requests across isolates is an architectural tenet of Aqueduct applications.</p>
<p>When an application is started with <code>aqueduct serve</code>, a flag indicates how many isolates the application should run on. This defaults to 3. An application will spawn that many isolates and create an instance of <code>RequestSink</code> for each. When an HTTP request is received, one of the isolates - and its <code>RequestSink</code> - will receive the request while the others will never see it. Each isolate works independently of each other, running as their own "web server" within a web server. Because a <code>RequestSink</code> initializes itself in the exact same way on each isolate, each isolate behaves exactly the same way.</p>
<p>An isolate can't share memory with another isolate. Therefore, each <code>RequestSink</code> instance has its own set of resources, like database connections. This behavior also makes connection pooling a non-issue - the connections are effectively pooled by the fact that there is a pool of <code>RequestSink</code>s. If a <code>RequestSink</code> creates a database connection and an application is started with four isolates, there will be four database connections total.</p>
<p>However, there are times where you want your own pool or you want to share a single resource across multiple isolates. For example, an API that must register with some other server (like in a system with an event bus) or must maintain a single persistent connection (like the error pipe to Apple's Push Notification Service or a streaming connection to Nest). These types of resources should be instantiated in <code>initializeApplication</code>.</p>
<h2 id="preprocessing-requests-and-initialhandler">Preprocessing Requests and initialHandler</h2>
<p>By default, when a <code>RequestSink</code> receives an HTTP request, it immediately forwards it to its <code>router</code>. However, if an application wishes to take some action prior to routing, use another router or forego routing altogether, the <code>Router</code> can be skipped. Every <code>RequestSink</code> has an <code>initialHandler</code> property that it forwards all requests to. This property defaults to the request sink's <code>router</code>, but can be overridden to return something else.</p>
<p>If you only wish to preprocess a request, you may instead override <code>RequestSink.willReceiveRequest</code>. This asynchronous method takes the incoming <code>Request</code> as an argument, but can't respond to it.</p>
<h2 id="the-application-object">The Application Object</h2>
<p>Hidden in all of this discussion is the <code>Application&lt;T&gt;</code> object. Because the <code>aqueduct serve</code> command manages creating <code>Application&lt;T&gt;</code> instances, your code rarely concerns itself with this type.</p>
<p>An <code>Application&lt;T&gt;</code> is the top-level object in an Aqueduct application; it setups up HTTP listeners and channels their requests to <code>RequestSink</code> instances. The <code>Application&lt;T&gt;</code> itself is just a generic container for <code>RequestSink</code>s; it doesn't do much other than kick everything off.</p>
<p>The application's <code>start</code> method will initialize at least one instance of the application's <code>RequestSink</code>. If something goes wrong during this initialization process, the application will throw an exception and halt starting the server. For example, setting up an invalid route in a <code>RequestSink</code> subclass would trigger this type of startup exception.</p>
<p>An <code>Application&lt;T&gt;</code> has a number of options that determine how it will listen for HTTP requests, such as which port it is listening on or the SSL certificate it will use. These values are available in the application's <code>configuration</code> property, an instance of <code>ApplicationConfiguration</code>.</p>
<p>An application will likely have other kinds of configurable options that are specific to the application, like connection information for a database. For this purpose, <code>ApplicationConfiguration</code> has a <code>options</code> property - a <code>Map</code> - that takes dynamic data. This type of information usually comes from a configuration file or environment variables. This information is simply forwarded to every <code>RequestSink</code> during their initialization.</p>
<p>Properties of an <code>ApplicationConfiguration</code> and <code>Application&lt;T&gt;</code> are provided through the <code>aqueduct serve</code> command.</p>
              
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../routing/" title="Routing" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Routing
              </span>
            </div>
          </a>
        
        
          <a href="../http_controller/" title="Handling Requests: HTTPController" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Handling Requests: HTTPController
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Built by stable|kernel
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-30ac6a1727.js"></script>
      <script>app.initialize({url:{base:"../.."}})</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41269877-2","aqueduct.io"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>