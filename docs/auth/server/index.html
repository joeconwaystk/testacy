
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Aqueduct, a Dart server-side framework.">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.1, mkdocs-material-1.1.1">
    
    
      
        <title>Setting up Authorization - Aqueduct</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-4ebe3f1d68.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../style/css/override.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Aqueduct" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  OAuth 2.0
                </span>
              
            
            Setting up Authorization
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Aqueduct
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/getting-started/" title="1. Getting Started" class="md-nav__link">
      1. Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/writing-tests/" title="2. Writing Tests" class="md-nav__link">
      2. Writing Tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/executing-queries/" title="3. Executing Database Queries" class="md-nav__link">
      3. Executing Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/model-relationships-and-joins/" title="4. Advanced Database Queries" class="md-nav__link">
      4. Advanced Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/deploying-and-other-fun-things/" title="5. Deploying" class="md-nav__link">
      5. Deploying
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      HTTP
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        HTTP
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/structure/" title="Application Structure" class="md-nav__link">
      Application Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_and_response/" title="Request and Response Objects" class="md-nav__link">
      Request and Response Objects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_controller/" title="Handling Requests: Fundamentals" class="md-nav__link">
      Handling Requests: Fundamentals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/routing/" title="Routing" class="md-nav__link">
      Routing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_sink/" title="Initialization and the RequestSink" class="md-nav__link">
      Initialization and the RequestSink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/http_controller/" title="Handling Requests: HTTPController" class="md-nav__link">
      Handling Requests: HTTPController
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/cors/" title="CORS Configuration" class="md-nav__link">
      CORS Configuration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Database/ORM
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Database/ORM
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/modeling_data/" title="Modeling Data" class="md-nav__link">
      Modeling Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/serialization/" title="Storage, Serialization and Deserialization" class="md-nav__link">
      Storage, Serialization and Deserialization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/executing_queries/" title="Executing Queries" class="md-nav__link">
      Executing Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/advanced_queries/" title="Advanced Queries" class="md-nav__link">
      Advanced Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/db_tools/" title="Migration and Tooling" class="md-nav__link">
      Migration and Tooling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/inside_the_db/" title="Inside the DB" class="md-nav__link">
      Inside the DB
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      OAuth 2.0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        OAuth 2.0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Setting up Authorization
      </label>
    
    <a href="./" title="Setting up Authorization" class="md-nav__link md-nav__link--active">
      Setting up Authorization
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-instances-of-authserver-and-authstorage" title="Creating Instances of AuthServer and AuthStorage" class="md-nav__link">
    Creating Instances of AuthServer and AuthStorage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-managedauthstorage" title="Using ManagedAuthStorage" class="md-nav__link">
    Using ManagedAuthStorage
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../authorizer/" title="Protected Routes" class="md-nav__link">
      Protected Routes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../controllers/" title="Issuing Access Tokens" class="md-nav__link">
      Issuing Access Tokens
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cli/" title="Creating OAuth 2.0 Clients" class="md-nav__link">
      Creating OAuth 2.0 Clients
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../what_is_oauth/" title="What is OAuth 2.0?" class="md-nav__link">
      What is OAuth 2.0?
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Testing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Testing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/harness/" title="Test Harness" class="md-nav__link">
      Test Harness
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/test_client/" title="Writing Tests and the TestClient" class="md-nav__link">
      Writing Tests and the TestClient
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_local/" title="Deploy Locally" class="md-nav__link">
      Deploy Locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_heroku/" title="Deploy on Heroku" class="md-nav__link">
      Deploy on Heroku
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_aws/" title="Deploy on AWS" class="md-nav__link">
      Deploy on AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/script/" title="Deploying without aqueduct serve" class="md-nav__link">
      Deploying without aqueduct serve
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-instances-of-authserver-and-authstorage" title="Creating Instances of AuthServer and AuthStorage" class="md-nav__link">
    Creating Instances of AuthServer and AuthStorage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-managedauthstorage" title="Using ManagedAuthStorage" class="md-nav__link">
    Using ManagedAuthStorage
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/stablekernel/aqueduct/edit/master/docs/auth/server.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                <h1 id="creating-authservers-to-authenticate-and-authorize">Creating AuthServers to Authenticate and Authorize</h1>
<p>An instance of <code>AuthServer</code> handles creating, verifying and refreshing authorization tokens. An instance of <code>AuthServer</code> is created when an application starts up and is referenced by <code>Authorizer</code>s, <code>AuthCodeController</code>s and <code>AuthController</code>s to manage authorization. <code>AuthServer</code> handles the logic of authorization, and when it needs to fetch or store persistent data, it invokes a callback on its <code>AuthStorage</code>. Therefore, an <code>AuthServer</code> must have <code>AuthStorage</code> to persist authorization objects like tokens, clients and resource owners.</p>
<h2 id="creating-instances-of-authserver-and-authstorage">Creating Instances of AuthServer and AuthStorage</h2>
<p>One instance of <code>AuthServer</code> is created in a <code>RequestSink</code>'s constructor along with its instance of <code>AuthStorage</code>. <code>AuthStorage</code> is an interface and a concrete implementation of it - <code>ManagedAuthStorage&lt;T&gt;</code> - exists in an optional library in Aqueduct, <code>aqueduct/managed_auth</code>. It is strongly recommended to use an instance of <code>ManagedAuthStorage&lt;T&gt;</code> because it has been thoroughly tested and handles cleaning up unused tokens.</p>
<p><code>ManagedAuthStorage</code> declares and uses <code>ManagedObject</code>s to represent authorization objects. Therefore, it must have a reference to <code>ManagedContext</code> (see <a href="../../db/overview/">Aqueduct ORM</a>). Initialization looks like this:</p>
<div class="codehilite"><pre><span></span><span class="k">import</span> <span class="s1">&#39;package:aqueduct/aqueduct.dart&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">&#39;package:aqueduct/managed_auth.dart&#39;</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyRequestSink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">MyRequestSink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedContext</span><span class="p">(...);</span>
    <span class="kd">var</span> <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedAuthStorage</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
    <span class="n">authServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthServer</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">AuthServer</span> <span class="n">authServer</span><span class="p">;</span>
  <span class="n">ManagedContext</span> <span class="n">context</span><span class="p">;</span>

  <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<p>Notice that the <code>aqueduct/managed_auth</code> library is imported - this library is not part of <code>aqueduct/aqueduct</code> by default and must be imported explicitly. Also notice that <code>ManagedAuthStorage</code> has a type argument that will be covered in the next section.</p>
<p>It's important to keep a property reference to an instance of <code>AuthServer</code> so that later methods in the initialization process - specifically, <code>setupRouter</code> - can use it to protect routes and add routes that grant authorization tokens.</p>
<p>While <code>AuthServer</code> has methods for handling authorization tasks, it is rarely used directly. Instead, <code>AuthCodeController</code> and <code>AuthController</code> are hooked up to routes to grant authorization tokens via the API. Instances of <code>Authorizer</code> secure routes when building processing pipelines in <code>setupRouter</code>. All of these types have a reference to an <code>AuthServer</code> and invoke the appropriate methods to carry out their task.</p>
<p>Therefore, a full authorization implementation rarely extends past a <code>RequestSink</code>. Here's an example <code>RequestSink</code> subclass that sets up and uses authorization:</p>
<div class="codehilite"><pre><span></span><span class="k">import</span> <span class="s1">&#39;package:aqueduct/aqueduct.dart&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">&#39;package:aqueduct/managed_auth.dart&#39;</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyRequestSink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">MyRequestSink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedContext</span><span class="p">(...);</span>
    <span class="kd">var</span> <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedAuthStorage</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
    <span class="n">authServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthServer</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">AuthServer</span> <span class="n">authServer</span><span class="p">;</span>
  <span class="n">ManagedContext</span> <span class="n">context</span><span class="p">;</span>

  <span class="kt">void</span> <span class="n">setupRouter</span><span class="p">(</span><span class="n">Router</span> <span class="n">router</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Set up auth token route</span>
    <span class="n">router</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/auth/token&quot;</span><span class="p">).</span><span class="n">generate</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">AuthController</span><span class="p">(</span><span class="n">authServer</span><span class="p">));</span>

    <span class="c1">// Set up auth code route</span>
    <span class="n">router</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/auth/code&quot;</span><span class="p">).</span><span class="n">generate</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">AuthCodeController</span><span class="p">(</span><span class="n">authServer</span><span class="p">));</span>

    <span class="c1">// Set up protected route</span>
    <span class="n">router</span>
      <span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/protected&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">new</span> <span class="n">Authorizer</span><span class="p">.</span><span class="n">bearer</span><span class="p">(</span><span class="n">authServer</span><span class="p">))</span>
      <span class="p">.</span><span class="n">generate</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">ProtectedController</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>For more details on authorization controllers, see <a href="../controllers/">Authorization Controllers</a>. For more details on securing routes, see <a href="../authorizer/">Authorizers</a>.</p>
<h2 id="using-managedauthstorage">Using ManagedAuthStorage</h2>
<p><code>ManagedAuthStorage&lt;T&gt;</code> is a concrete implementation of <code>AuthStorage</code>, providing storage of authorization tokens and clients for <code>AuthServer</code>. Storage is accomplished by Aqueduct's ORM. <code>ManagedAuthStorage&lt;T&gt;</code>, by default, is not part of the standard <code>aqueduct/aqueduct</code> library. To use this class, an application must import <code>package:aqueduct/managed_auth.dart</code>.</p>
<p>The type argument to <code>ManagedAuthStorage&lt;T&gt;</code> represents the concept of a 'user' or 'account' in an application - OAuth 2.0 terminology would refer to this concept as a <em>resource owner</em>.</p>
<p>The type argument must be a <code>ManagedObject&lt;T&gt;</code> subclass that is specific to your application. Its persistent type must <em>extend</em> <code>ManagedAuthenticatable</code> and the subclass itself must implement <code>ManagedAuthResourceOwner</code>. A basic definition may look like this:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="n">ManagedObject</span><span class="o">&lt;</span><span class="n">_User</span><span class="o">&gt;</span>
    <span class="kd">implements</span> <span class="n">_User</span><span class="p">,</span> <span class="n">ManagedAuthResourceOwner</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">managedTransientInputAttribute</span>
  <span class="kt">void</span> <span class="kd">set</span> <span class="n">password</span><span class="p">(</span><span class="kt">String</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">AuthUtility</span><span class="p">.</span><span class="n">generateRandomSalt</span><span class="p">();</span>
    <span class="n">hashedPassword</span> <span class="o">=</span> <span class="n">AuthUtility</span><span class="p">.</span><span class="n">generatePasswordHash</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">_User</span> <span class="kd">extends</span> <span class="n">ManagedAuthenticatable</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">ManagedColumnAttributes</span><span class="p">(</span><span class="nl">unique:</span> <span class="kc">true</span><span class="p">)</span>
  <span class="kt">String</span> <span class="n">email</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>By extending <code>ManagedAuthenticatable</code>, the persistent type has an integer primary key, a unique username, a hashed password (and its salt) and a <code>ManagedSet&lt;T&gt;</code> of authorization tokens that have been granted by this user. These are the necessary attributes that the type argument to <code>ManagedAuthStorage&lt;T&gt;</code> must have for an <code>AuthServer</code> to properly store and fetch resource owners. The interface <code>ManagedAuthResourceOwner</code> is a requirement that ensures the type argument is both a <code>ManagedObject&lt;T&gt;</code> and <code>ManagedAuthenticatable</code>, and serves no other purpose than to restrict <code>ManagedAuthStorage&lt;T&gt;</code>'s type parameter to an appropriate type.</p>
<p>The purpose of this structure is to allow an application to declare its own resource owner type - with additional attributes and relationships - while still enforcing the needs of Aqueduct's OAuth 2.0 implementation.</p>
<p>Once a resource owner has been defined, instances of <code>ManagedAuthStorage&lt;T&gt;</code> can be created and passed to an <code>AuthServer</code>:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedContext</span><span class="p">(...);</span>
<span class="kd">var</span> <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedAuthStorage</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthServer</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
</pre></div>


<p>The <code>aqueduct/managed_auth</code> library also declares two <code>ManagedObject&lt;T&gt;</code> subclasses. <code>ManagedToken</code> represents instances of authorization tokens and codes, and <code>ManagedClient</code> represents instances of OAuth 2.0 clients. Both of these types must be visible to the <code>aqueduct db</code> tool, and so the library must at least be imported in an application's library file. Since these types will at least be referenced by the definition of the resource owner, it makes sense to export <code>package:aqueduct/managed_auth.dart</code> from an application's library file. It's rare that these types are referenced elsewhere in an application, since they exist to serve the behavior of <code>AuthServer</code>.</p>
<p><code>ManagedAuthStorage&lt;T&gt;</code> will delete authorization tokens and codes when they are no longer in use. This is determined by how many tokens a resource owner has and the tokens expiration dates. Once a resource owner acquires more than 40 tokens/codes, the oldest tokens/codes (determined by expiration date) are deleted. Effectively, the resource owner is limited to 40 tokens. This number can be changed when instantiating <code>ManagedAuthStorage&lt;T&gt;</code>:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedAuthStorage</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nl">tokenLimit:</span> <span class="m">20</span><span class="p">);</span>
</pre></div>
              
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../overview/" title="Overview" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Overview
              </span>
            </div>
          </a>
        
        
          <a href="../authorizer/" title="Protected Routes" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Protected Routes
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Built by stable|kernel
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-30ac6a1727.js"></script>
      <script>app.initialize({url:{base:"../.."}})</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41269877-2","aqueduct.io"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>